:stem:

= SPPF

A #shared packed parse forest# (SPPF) is a representation of all of the derivation trees of a given
string a1 . . . an. It's designed to reduce the space required to represent multiple derivation tree

* In the worst case an SPPF can be of unbounded polynomial size
* In binarized form -- worst case cubic size

Contains two types of nodes:

* *symbol* nodes (x, j, i) corresponds to the parsing of substring [i, j] by symbol x. Where 
** x is a terminal or nonterminal: stem:[x \in \{T, N,\epsilon}]. For stem:[x \in N], `x` has one or more packed node children.
** (i, j) -- extent,  0 ≤ j ≤ i ≤ m. 

 Extent ensure that symbol node uniquely identified with it's label (x, j, i)

* *packed* nodes (i), correspond number of rule. We create new packed node for each derivation variant.

  If the grammar is ambiguous a node can have several families of children, corresponding to different parses of the string. Each family is grouped together under a packed node.


Ambiguous result of the parsing:

*set of AST*

image::bin_sppf/2024-01-11-17-50-08.png[]

*SPPF* 

image::bin_sppf/2024-01-11-17-50-30.png[]

In an SPPF, nodes which have the same tree below them are shared and nodes which correspond to different derivations of the same substring from the same nonterminal are combined by creating a packed node for each family of children. 


image::bin_sppf/2024-01-11-17-50-41.png[]


== Binarized SPPF

In order to ensure that the parser has worst-case cubic runtime, the SPPFs are binarized by introducing #intermediate nodes#. 

* *intermediate* node (L, j, i), where 
** L -- grammar slot the form stem:[A := α · β].
** (i, j) -- extends

 For ambiguous grammars, intermediate node can have several families (?) of children, also grouped together under packed nodes.

 Have packed or symbol nodes as children.

* *packed* nodes (L, k), where 
** L is a grammar slot stem:[X := (\alpha x \cdot \beta, k)]. 
** k is a pivot --  0 ≤ k ≤ m, is an input position
** Have one or two children 
*** Right it's a symbol node stem:[(x, k, i)] which is equal to the left extent of the packed nodes right child.
*** [optional] Left it's a symbol node labelled stem:[X := (\alpha \cdot x \beta, k)] or stem:[(y, j, k)] if stem:[y = \alpha, |\alpha| = 1]. 

 So, we move position in grammar to left. We can say that by intermediate bode we can represent a rule X := abcd as sequence of `binarized` rules X := Cd, C := Bc, B := ab.

* Symbol nodes now has as a children packed nodes -- one for each derivation variant.


=== Example 1 <<sjb19>>

Grammar 

```
S := b a c | b a a | b A c 
A := a
```

SPPF for string `bac`

image::bin_sppf/sppf_sjb_1.png[]

==== Symbol nodes 
Symbol nodes of the SPPF are highlighted in red color.

image::bin_sppf/symbol.png[]

Upper symbol node in the image above means that the non-terminal S parses a substring from 0 to 3.

==== Packed nodes 
image::bin_sppf/packed.png[]

Each packed node (highlighted in red) notes which derivation rule was used (even if the derivation is deterministic). 

The two packed node children of the root node (S, 0, 3) correspond to *two derivations*, one using
each of the rules which label the packed nodes. The SPPF embeds the two (binarized) derivation
trees below.

image::bin_sppf/sppf_sjb_2.png[]


==== Intermediate 
Intermediate node are rectangular. They are used to present a rule S := bAc 
as sequence of “binarized” rules 

On the left side 
```
S := S` c
S` := b a
```

On the right side 
```
S := S`` c
S`` := b A
```


image::bin_sppf/intermediate.png[]


=== Example 2 <<izm>>

image::bin_sppf/sppf_izm_1.png[]

=== Example 3 <<izm>>

image::bin_sppf/sppf_izm.png[]

=== Example 4

Grammar: 

stem:[
S \to ABCD, \ A \to a, \ B \to b, \ C \to c, \ D \to d 
]

*Simple SPPF*

image::bin_sppf/2024-01-11-18-25-29.png[]

*Binarized SPPF*

image::bin_sppf/2024-01-11-18-26-18.png[]

=== SPPF Construction
#TODO

[bibliography]
== References

* [[[sjb19]]] Elizabeth Scott, Adrian Johnstone, L. Thomas van Binsbergen,
Derivation representation using binary subtree sets,
Science of Computer Programming, Volume 175,
2019, Pages 63-84
* [[[izm]]] thesis Izmailova